---
title: TCP/IP
date: 2025-05-26 16:33:00 +0800
categories: [协议及操作系统]
tags: [网络协议, 操作系统]     
description: TCP/IP 协议
pin: true   #置顶帖子
math: true
mermaid: true
author: <id_1>
# toc: false #目录是否关闭
# comments: true
---

## 1. TCP/IP 网络模型

传输层两个协议 TCP UDP
- TCP： 面向连接的，可靠的通信协议。
- UDP： 只负责数据包发送，不管数据包能否到达。效率较高，适用于传输量大场景。

## 2. UDP 连接

  利用 IP 的[无连接]的通信服务。协议简单，UDP头为8个字节64位。

  ![img-description](/assets/img/2025-05-26/udp.png)
  _图1 udp 头部格式示意图_
  - 源端口号及目标端口号：确定收发进程
  - 包长度：确定UDP头部长度及数据长度
  - 校验和：数据包校验，防止传输数据包受损

  udp首部长度固定为8字节，因而不需要首部长度字段，仅需要包长度。

  应用场景：
  1. 总量较少通信 DNS, SNMP等。
  2. 视频音频及广播通信。

## 3. TCP 连接
  一对一的连接方式，服务端和客户端之间。需要三层信息：
  1. **socket** : 套接字，由ip 和端口号组成，用于确定收发双方地址信息。
  2. **序列号**： 解决乱序问题。
  3. **窗口大小**：用于做流量控制。

  ![img-description](/assets/img/2025-05-26/tcp.png)
  _图2 tcp 头部格式示意图_
  tcp 四元组确定一个可靠的TCP连接，包括：
  - 源地址，目的地址：位于IP头部，32位，用于确定发送与接收主机。
  - 源端口，目标端口：位于TCP头部，16位，用于确定发送与接收的进程。
  <mark> 最大TCP连接数 = 客户端IP数 * 客户端端口数 <mark>

## 4. TCP 三次握手

  ![img-description](/assets/img/2025-05-26/TCP三次握手.png)
  _图3 tcp 三次握手示意图_

  - 客户端与服务端处于 `close` 状态
  - 客户端初始化序列号 `client_isn` ， 将`SYN`位置 1 代表该报文为SYN报文， 发送SYN报文。客户端进入`SYN-SENT`状态，服务端进入`LISTEN`状态。
  - 服务端接收到第一个SYN报文，服务端初始化序列号`server-isn`将`SYN` `ACK`位置1代表为服务端返回的SYN应答报文。同时填入确认应答号 `client_isn + 1` 。服务端进入`SYN_RCVD`状态。
  - 客户端接收到服务端第二个SYN报文，客户端将`ACK`位置1， 填入确认应答号为`server_num + 1`。发送第三个SYN报文及客户端应答信号给服务端。客户端进入`ESTABLISHED`状态。
  - 服务端接收到客户端应答报文，服务端进入`ESTABLISHED`状态。三次握手结束，简历可靠通信，可以开始传输数据。

## 5. LINUX系统中查看TCP状态指令

  `netstat -napt` 

## 6. 三次握手主要原因

  &emsp;&emsp;防止**历史连接**初始化当前连接。因为在网络拥堵情况下，针对第一次握手，旧的 SYN 报文可能比新的 SYN 报文先到达服务端。因为三次握手机制的存在，服务端会返回应答信号包含确认应答号`client_isn + 1`， 如果与客户端最新发送的`client_isn`不一致则客户端会发送`RST`重置报文。一致的情况才进行后续应答信号的发送与可靠连接的建立。因此可以避免历史连接初始化当前连接。
